name: Python Application CI

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main" ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11' # 사용하는 파이썬 버전

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller google-generativeai # Pillow 등 다른 라이브러리도 필요하면 추가
        # 또는 requirements.txt 사용:
        # pip install -r requirements.txt

    - name: Build with PyInstaller (onedir) # 단계 이름에 (onedir) 추가하여 명시
      run: |
        pyinstaller --name MnbTranslator --onedir --windowed --icon="assets/app_icon.ico" --add-data "data:data" --add-data "assets:assets" main.py
        # '--onefile' 옵션을 '--onedir'로 변경했습니다.

    - name: Archive build artifacts (Windows) # 아티팩트 이름 및 경로 수정
      uses: actions/upload-artifact@v4
      with:
        name: MnbTranslator-Windows-dir # 아티팩트 이름에 -dir 추가하여 구분
        path: dist/MnbTranslator # '--onedir'로 빌드하면 'dist/YourAppName' 폴더가 생성됨

  create-release:
    needs: build-windows
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Windows artifact (directory)
        uses: actions/download-artifact@v4
        with:
          name: MnbTranslator-Windows-dir # 이전 단계에서 업로드한 아티팩트 이름
          path: ./dist_build              # 현재 작업 디렉토리 아래에 dist_build 폴더를 만들고 여기에 아티팩트 내용 다운로드

      - name: List downloaded files # 다운로드된 파일 목록 확인 (디버깅용)
        run: ls -R ./dist_build

      - name: Create archive of the build directory
        run: |
          # dist_build 폴더 안에 PyInstaller 빌드 결과물(MnbTranslator.exe 등)이 직접 위치함
          cd ./dist_build
          # 현재 디렉토리(./dist_build)의 모든 내용을 포함하여 zip 파일 생성
          # zip 파일은 한 단계 상위, 즉 작업 공간 루트에 생성됨
          zip -r ../MnbTranslator-Windows-${{ github.ref_name }}.zip .
        # Ubuntu Runner에서는 위 zip 명령이 잘 동작합니다.

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false

      - name: Upload Release Asset (Windows ZIP)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          # 압축 파일은 작업 공간 루트에 생성되었으므로 경로 수정
          asset_path: ./MnbTranslator-Windows-${{ github.ref_name }}.zip
          asset_name: MnbTranslator-Windows-${{ github.ref_name }}.zip
          asset_content_type: application/zip